{% extends "base.html" %}

{% block title %}Blocos de Carnaval MG{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#E91E63">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/carnaval-mask-icon.png') }}">
{% endblock %}

{% block content %}
    
    <div class="main-content-grid">
        
        <div class="left-column">
            <div class="map-container">
                {% include "map.html" %}
            </div>

            <div class="desktop-map-ad">
                <div class="ad-text">
                    <h3>Sua Marca Aqui! üöÄ</h3>
                    <p>Milhares de foli√µes acessam este mapa. Divulgue seu neg√≥cio.</p>
                </div>
                <a href="https://biolink.info/marllonca" target="_blank" class="directions-btn" 
                   style="background-color: #f1c40f; color: #333; border: none; padding: 8px 16px; flex: 0 0 auto;"
                   onclick="trackEvent('clique_anuncio', { 'origem': 'mapa_desktop', 'url_destino': this.href })">
                    Anunciar
                </a>
            </div>
        </div>

        <div class="events-list-container">
            
            <div class="filters-wrapper" id="filters-desktop-wrapper">
                <div class="filtros-container">
                    
                    <form id="filter-form" method="GET" action="{{ url_for('mostrar_eventos') }}" autocomplete="off">
                        
                        <div class="quick-filters">
                            <div class="filter-group">
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="sab_oficial" {% if 'sab_oficial' in request.args.getlist('quick_filter') %}checked{% endif %}><span class="chip-destaque">S√°b 14</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="dom_oficial" {% if 'dom_oficial' in request.args.getlist('quick_filter') %}checked{% endif %}><span class="chip-destaque">Dom 15</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="seg_oficial" {% if 'seg_oficial' in request.args.getlist('quick_filter') %}checked{% endif %}><span class="chip-destaque">Seg 16</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="ter_oficial" {% if 'ter_oficial' in request.args.getlist('quick_filter') %}checked{% endif %}><span class="chip-destaque">Ter 17</span></label>
                            </div>
                            <div class="filter-group">
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="hoje" {% if 'hoje' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Hoje</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="amanha" {% if 'amanha' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Amanh√£</span></label>
                            </div>
                            <div class="filter-group">
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="em-andamento" {% if 'em-andamento' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Em Andamento</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="em-breve" {% if 'em-breve' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Em Breve</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="encerrando" {% if 'encerrando' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Encerrando</span></label>
                            </div>
                            <div class="filter-group">
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="pequeno" {% if 'pequeno' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Pequenos</span></label>                    
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="medio" {% if 'medio' in request.args.getlist('quick_filter') %}checked{% endif %}><span>M√©dios</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="grande" {% if 'grande' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Grandes</span></label>
                            </div>
                            <div class="filter-group">
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="manha" {% if 'manha' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Manh√£</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="tarde" {% if 'tarde' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Tarde</span></label>
                                <label class="chip-checkbox"><input type="checkbox" name="quick_filter" value="noite" {% if 'noite' in request.args.getlist('quick_filter') %}checked{% endif %}><span>Noite</span></label>
                            </div>
                        </div>

                        <input type="hidden" id="ne_lat" name="ne_lat" value="{{ request.args.get('ne_lat', '') }}">
                        <input type="hidden" id="ne_lng" name="ne_lng" value="{{ request.args.get('ne_lng', '') }}">
                        <input type="hidden" id="sw_lat" name="sw_lat" value="{{ request.args.get('sw_lat', '') }}">
                        <input type="hidden" id="sw_lng" name="sw_lng" value="{{ request.args.get('sw_lng', '') }}">
                        <input type="hidden" id="center_lat" name="center_lat" value="{{ request.args.get('center_lat', '') }}">
                        <input type="hidden" id="center_lng" name="center_lng" value="{{ request.args.get('center_lng', '') }}">
                        <input type="hidden" id="zoom" name="zoom" value="{{ request.args.get('zoom', '') }}">
                        <input type="hidden" id="map_style" name="map_style" value="{{ request.args.get('map_style', 'gps') }}">

                        <div class="filters-grid">
                            <div class="filtro-item">
                                <label for="data_filtro">Data:</label>
                                <input type="text" id="data_filtro" name="data_filtro" value="{{ request.args.get('data_filtro', '') }}" placeholder="Selecione..." style="background-color: var(--background-color);">
                            </div>
                            <div class="filtro-item">
                                <label for="bairro">Bairro:</label>
                                <select name="bairro" id="bairro">
                                    <option value="">Todos</option>
                                    {% for b in bairros %}
                                        <option value="{{ b }}" {% if request.args.get('bairro') == b %}selected{% endif %}>{{ b }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filtro-item">
                                <label for="categoria">Estilo:</label>
                                <select name="categoria" id="categoria">
                                    <option value="">Todos</option>
                                    {% for c in estilos %}
                                        <option value="{{ c }}" {% if request.args.get('categoria') == c %}selected{% endif %}>{{ c }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filtro-item filtro-busca">
                                <label for="q">Buscar:</label>
                                <input type="text" id="q" name="q" placeholder="Nome..." value="{{ request.args.get('q', '') }}">
                            </div>
                        </div>

                        <div class="filter-actions-row filter-footer">
                            <button type="submit" class="btn-filtrar" onclick="trackEvent('filtrar_blocos', {'origem': 'filtros_gerais'})">Filtrar</button>
                            <button type="button" class="btn-limpar" onclick="resetApp()">Limpar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="info-banner">
                <div class="info-icon">üöß</div>
                <div class="info-text">
                    <strong>Aten√ß√£o:</strong> A lista oficial da PBH ainda n√£o saiu. 
                    Exibindo apenas <strong>Ensaios</strong> confirmados por enquanto!
                </div>
            </div>

            <div class="results-header">
                <p class="total-count">{{ total }} blocos encontrados.</p>
                
                <div class="fav-cluster">
                    <button id="share-favs-btn" class="share-favs-btn" onclick="shareAllFavorites()" title="Enviar lista no WhatsApp">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                    </button>

                    <div class="fav-toggle-wrapper">
                        <input type="checkbox" id="show-favorites-only">
                        <label for="show-favorites-only" title="Mostrar apenas favoritos">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            Meus Blocos
                        </label>
                    </div>
                </div>
            </div>

            <div class="eventos-grid" id="events-grid">
                {% for evento in eventos %}
                    <div class="evento-card status-bg-{{ evento.status }}" 
                         data-id="{{ evento.id }}"
                         data-lat="{{ evento.lat }}" 
                         data-lon="{{ evento.lon }}"
                         onclick="toggleCard(this)"> 
                        
                        {% if evento.status_label %}
                            <div class="status-tag status-{{ evento.status }}">
                                {{ evento.status_label }}
                            </div>
                        {% endif %}

                        <div class="mini-like-counter">
                            üíï <span class="mini-like-val">{{ evento.likes }}</span>
                        </div>

                        <div class="evento-info-compact">
                            <div class="card-header">
                                <h2>{{ evento.titulo }}</h2>
                                <div class="header-tags">
                                    {% if evento.is_kids or evento.is_lgbt or evento.is_pet %}
                                    <div class="icons-row">
                                        {% if evento.is_kids %}
                                        <span class="feature-icon feature-kids" title="Infantil"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M19 13H17.91C17.64 10.09 15.33 7.78 12.41 7.54V6C12.41 3.69 13.95 1.78 16.1 1.22C16.7 1.06 17.07 0.43 16.91 -0.17C16.75 -0.77 16.12 -1.14 15.52 -0.98C12.59 0.04 10.37 2.22 10.04 5H9.96C6.66 5.37 4 8.27 4 11.75V15H6V18C6 19.66 7.34 21 9 21C10.66 21 12 19.66 12 18V15H15.5V18C15.5 19.66 16.84 21 18.5 21C20.16 21 21.5 19.66 21.5 18V16.29C23.05 15.38 24 13.62 24 11.75V11C24 10.45 23.55 10 23 10C22.45 10 22 10.45 22 11V11.75C22 12.85 21.1 13.75 20 13.75V13H19ZM9 18C8.45 18 8 17.55 8 17V15H10V17C10 17.55 9.55 18 9 18ZM18.5 18C17.95 18 17.5 17.55 17.5 17V16H19.5V17C19.5 17.55 19.05 18 18.5 18Z" transform="translate(0, 2)"/> </svg></span>
                                        {% endif %}
                                        {% if evento.is_lgbt %}
                                        <span class="feature-icon feature-lgbt" title="LGBTQIA+"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" stroke="none"><rect x="2" y="4" width="28" height="4" fill="#FF4B4B"/><rect x="2" y="8" width="28" height="4" fill="#FFB04B"/><rect x="2" y="12" width="28" height="4" fill="#FFEB3B"/><rect x="2" y="16" width="28" height="4" fill="#4CAF50"/><rect x="2" y="20" width="28" height="4" fill="#2196F3"/><rect x="2" y="24" width="28" height="4" fill="#9C27B0"/></svg></span>
                                        {% endif %}
                                        {% if evento.is_pet %}
                                        <span class="feature-icon feature-pet" title="Pet Friendly"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2C10.5 2 9 3.5 9 5C9 6.5 10.5 8 12 8C13.5 8 15 6.5 15 5C15 3.5 13.5 2 12 2ZM5 5C3.5 5 2 6.5 2 8C2 9.5 3.5 11 5 11C6.5 11 8 9.5 8 8C8 6.5 6.5 5 5 5ZM19 5C17.5 5 16 6.5 16 8C16 9.5 17.5 11 19 11C20.5 11 22 9.5 22 8C22 6.5 20.5 5 19 5ZM4 13.5C4 16.5 6 22 12 22C18 22 20 16.5 20 13.5C20 12 18 10 16 10C14.5 10 14 11 12 11C10 11 9.5 10 8 10C6 10 4 12 4 13.5Z"/></svg></span>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    {% if evento.is_ensaio %}
                                        <span class="categoria-tag tag-ensaio">‚ú® Ensaio</span>
                                    {% else %}
                                        <span class="tamanho-tag tamanho-{{ evento.tamanho }}">
                                            {% if evento.tamanho == 3 %}Grande üë•üë•üë•{% elif evento.tamanho == 2 %}M√©dio üë•üë•{% else %}Pequeno üë•{% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="card-meta">
                                <div class="meta-row date-row">
                                    <div class="date-wrapper">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                        <strong>{{ evento.data }}</strong>
                                    </div>
                                    
                                    {% if not evento.is_ensaio %}
                                        <span class="categoria-tag">{{ evento.categoria_display }}</span>
                                    {% endif %}
                                </div>
                                <div class="meta-row address-row">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                    <span>{{ evento.endereco }}</span>
                                </div>
                            </div>

                            {% if evento.link_ingresso %}
                            <div class="card-desc">
                                <a href="{{ evento.link_ingresso }}" target="_blank" class="btn-ingresso" onclick="trackEvent('clique_ingresso', {'bloco': '{{ evento.titulo }}', 'origem': 'card'})">
                                    üéüÔ∏è Retirar Ingressos
                                </a>
                            </div>
                            {% endif %}

                            <div class="expand-content">
                                <div class="card-actions">
                                    {% if evento.lat and evento.lon %}
                                    <button class="directions-btn" onclick="getDirections({{ evento.lat }}, {{ evento.lon }}, event)">
                                        üöó Como Chegar
                                    </button>
                                    {% endif %}
                                    
                                    <button class="share-btn" title="Compartilhar no WhatsApp" onclick="shareBlock('{{ evento.id }}', '{{ evento.titulo }}', '{{ evento.data }}', event)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="18" cy="5" r="3"></circle>
                                            <circle cx="6" cy="12" r="3"></circle>
                                            <circle cx="18" cy="19" r="3"></circle>
                                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                        </svg>
                                    </button>

                                    <button class="fav-btn" title="Curtir" onclick="toggleFavorite('{{ evento.id }}', event)">
                                        <svg class="heart-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                        <span class="like-count">{{ evento.likes }}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if loop.index > 0 and loop.index % 5 == 0 %}
                    <div class="evento-card ad-card in-feed">
                        <div class="ad-label">Publicidade</div>
                        <div class="ad-content">
                            <h3>Sua Marca Aqui! üöÄ</h3>
                            <p>Destaque seu neg√≥cio para milhares de foli√µes durante o Carnaval de BH.</p>
                            <a href="https://biolink.info/marllonca" target="_blank" class="directions-btn" style="background-color: #f1c40f; color: #333; border: none;"
                               onclick="trackEvent('clique_anuncio', { 'origem': 'feed_lista', 'url_destino': this.href })">
                                Anunciar Agora
                            </a>
                        </div>
                    </div>
                    {% endif %}

                {% else %}
                    <p style="grid-column: 1/-1; text-align: center; margin-top: 2em; color: var(--text-secondary);">
                        Nenhum bloco encontrado nesta √°rea/filtro.
                    </p>
                {% endfor %}
            </div>
        </div>

        <button id="mobile-filter-btn" class="mobile-filter-btn" title="Abrir Filtros">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </button>

        <div id="mobile-filter-modal" class="mobile-filter-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Filtros</h2>
                    <button id="close-modal-btn" class="close-modal-btn">√ó</button>
                </div>
                <div id="mobile-filters-container"></div>
            </div>
        </div>

        <div id="welcome-modal" class="modal" style="z-index: 3000;">
            <div class="modal-content welcome-content">
                <div class="welcome-icon">üé≠</div> 
                
                <h3>O Carnaval t√° chegando!</h3>
                <p>
                    Estamos em ritmo de aquecimento! üî•
                    <br><br>
                    Por enquanto, exibimos os <strong>Ensaios</strong> e alguns blocos de <strong>Pr√©-Carnaval</strong> j√° confirmados.
                    <br><br>
                    Assim que a programa√ß√£o oficial completa for divulgada pela PBH, atualizaremos o mapa automaticamente. Divirta-se!
                </p>
                <button id="close-welcome-btn" class="directions-btn" style="width: 100%; margin-top: 15px; border:none;">
                    Bora pro bloco!
                </button>
            </div>
        </div>

        <div id="nav-modal" class="modal" style="z-index: 4000;">
            <div class="modal-content nav-modal-content">
                <button onclick="closeNavModal()" class="close-modal-btn">√ó</button>
                <h3>Como voc√™ quer ir? üöó</h3>
                
                <div class="nav-options">
                    <button class="nav-option-btn btn-google" onclick="openApp('google')">
                        <img src="{{ url_for('static', filename='images/googlemaps-logo.png') }}" alt="Google Maps">
                        Google Maps
                    </button>
                    <button class="nav-option-btn btn-waze" onclick="openApp('waze')">
                        <img src="{{ url_for('static', filename='images/waze-logo.png') }}" alt="Waze">
                        Waze
                    </button>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<script>
    const hasActiveFilters = {{ 'true' if has_filters else 'false' }};

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); });
    }

    const statusColors = {
        'em-andamento': '#27ae60', 'em-breve': '#2196F3', 'encerrando': '#d35400',
        'hoje': '#8e44ad', 'encerrado': '#95a5a6', 'futuro': '#E91E63'
    };

    // ... (fun√ß√µes cleanUrlParams, resetApp, shareBlock, shareAllFavorites mantidas iguais) ...
    // ... (fun√ß√µes getDirections, closeNavModal, openApp mantidas iguais) ...
    // ... (listeners de window e mapa mantidos iguais) ...

    function cleanUrlParams() {
        const url = new URL(window.location);
        const paramsToRemove = [
            'ne_lat', 'ne_lng', 'sw_lat', 'sw_lng', 'center_lat', 'center_lng', 'zoom',
            'quick_filter', 'status_filter', 'data_filtro', 'periodo_dia', 'bairro', 'categoria', 'q'
        ];
        let changed = false;
        paramsToRemove.forEach(param => { if (url.searchParams.has(param)) { url.searchParams.delete(param); changed = true; } });
        if (url.searchParams.has('highlight_id')) { url.searchParams.delete('highlight_id'); changed = true; }
        if (changed) window.history.replaceState({}, '', url);
    }

    function resetApp() {
        localStorage.removeItem('mapState');
        window.location.href = '/';
    }

    function shareBlock(id, title, date, event) {
        event.stopPropagation();
        const baseUrl = window.location.origin + window.location.pathname;
        const link = `${baseUrl}?highlight_id=${id}`;
        const lines = ["üé≠ *Olha esse bloco que eu achei!*", "", `üéâ *${title}*`, `üìÖ ${date}`, "", "üëá *Bora? Detalhes:*", link];
        const message = lines.join("\n");
        const waUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
        trackEvent('compartilhar_whatsapp', { 'bloco_id': id, 'bloco_nome': title });
        window.open(waUrl, '_blank');
    }

    function shareAllFavorites() {
        const favs = getFavorites();
        if (favs.length === 0) { alert("Voc√™ n√£o tem nenhum bloco favoritado."); return; }
        let msg = "üé≠ *Minha Lista de Blocos - Carnaval BH 2026*\n\n";
        let hasItems = false; let lastDay = "";
        document.querySelectorAll('.evento-card').forEach(card => {
            const id = card.dataset.id;
            if (favs.includes(id)) {
                const title = card.querySelector('h2').innerText;
                const rawDateText = card.querySelector('.date-wrapper strong').innerText;
                let datePart = rawDateText.split('-')[0].trim();
                if (datePart !== lastDay) { if (hasItems) msg += "------------------\n\n"; msg += `üóìÔ∏è *${datePart}*\n\n`; lastDay = datePart; }
                msg += `üéâ *${title}*\n\n`; hasItems = true;
            }
        });
        if (!hasItems) { alert("Nenhum bloco favorito encontrado na visualiza√ß√£o atual."); return; }
        msg += "üëá *Monte sua lista:*\n" + window.location.origin;
        const waUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
        trackEvent('compartilhar_lista', { 'quantidade': favs.length });
        window.open(waUrl, '_blank');
    }

    let currentDestLat = null; let currentDestLon = null;
    function getDirections(destLat, destLon, event) {
        if(event) event.stopPropagation();
        currentDestLat = destLat; currentDestLon = destLon;
        const modal = document.getElementById('nav-modal');
        if (modal) modal.classList.add('show');
        trackEvent('abrir_opcoes_rota', { 'destino_lat': destLat, 'destino_lon': destLon });
    }
    function closeNavModal() { document.getElementById('nav-modal').classList.remove('show'); }
    function openApp(app) {
        let url = ''; const lat = parseFloat(currentDestLat); const lon = parseFloat(currentDestLon);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (app === 'google') url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
        else if (app === 'waze') url = isMobile ? `https://waze.com/ul?ll=${lat},${lon}&navigate=yes` : `https://www.waze.com/live-map/directions?to=ll.${lat}%2C${lon}`;
        closeNavModal(); window.open(url, '_blank');
        trackEvent('como_chegar_click', { 'app': app, 'device': isMobile ? 'mobile' : 'desktop' });
    }
    window.addEventListener('click', (e) => { if (e.target === document.getElementById('nav-modal')) closeNavModal(); });

    function selectCardFromMap(id) {
        const card = document.querySelector(`.evento-card[data-id="${id}"]`);
        const container = document.querySelector('.events-list-container');
        if (card) {
            const title = card.querySelector('h2').innerText;
            trackEvent('interacao_mapa_clique', { 'bloco_nome': title });
            document.querySelectorAll('.evento-card').forEach(c => { c.style.order = '0'; c.classList.remove('expanded'); c.classList.remove('highlighted'); });
            card.style.order = '-1'; card.classList.add('expanded');
            card.classList.remove('highlighted'); void card.offsetWidth; card.classList.add('highlighted');
            setTimeout(() => card.classList.remove('highlighted'), 4000);
            if (container) container.scrollTo({ top: 0, behavior: 'smooth' });
            highlightMarker(id);
        }
    }

    function highlightMarker(id) {
        if (!window.markersMap) return;
        Object.values(window.markersMap).forEach(m => {
            m.marker.setStyle(m.defaultStyle);
            const el = m.marker.getElement(); if(el) el.classList.remove('marker-selected-anim');
        });
        if (id && window.markersMap[id]) {
            const current = window.markersMap[id];
            current.marker.setStyle({ fillOpacity: 1, color: '#fff', weight: 3, opacity: 1 });
            current.marker.bringToFront();
            const el = current.marker.getElement(); if(el) el.classList.add('marker-selected-anim');
        }
    }

    function toggleCard(card) {
        document.querySelectorAll('.evento-card.expanded').forEach(c => { if (c !== card) c.classList.remove('expanded'); });
        card.classList.toggle('expanded');
        if (card.classList.contains('expanded')) {
            const title = card.querySelector('h2').innerText;
            trackEvent('interacao_lista_expandir', { 'bloco_nome': title });
            card.classList.remove('highlighted'); void card.offsetWidth; card.classList.add('highlighted');
            setTimeout(() => card.classList.remove('highlighted'), 4000);
        }
        if (!card.classList.contains('expanded')) { highlightMarker(null); return; }
        const id = card.dataset.id; const lat = parseFloat(card.dataset.lat); const lon = parseFloat(card.dataset.lon);
        if (window.mapInstance && !isNaN(lat) && !isNaN(lon)) {
            window.mapInstance.flyTo([lat, lon], 16, { duration: 1.2 });
            highlightMarker(id);
        }
    }

    function getFavorites() { return JSON.parse(localStorage.getItem('my_blocos') || '[]'); }

    // --- SEGURAN√áA & GA4 USER ID ---
    function getUserId() {
        let uuid = localStorage.getItem('user_uuid');
        if (!uuid) {
            uuid = crypto.randomUUID ? crypto.randomUUID() : 'user-' + Date.now() + '-' + Math.random();
            localStorage.setItem('user_uuid', uuid);
            
            // NOVO: Evento GA4 - Novo Usu√°rio Gerado
            trackEvent('gerar_uuid', { 'novo': 'sim' });
        }
        
        // NOVO: Configura o User-ID no GA4 (se gtag existir)
        // Isso permite rastrear o mesmo usu√°rio em sess√µes diferentes
        if (typeof gtag === 'function') {
            gtag('config', '{{ ga_measurement_id }}', {
                'user_id': uuid
            });
        }
        return uuid;
    }

    // --- L√ìGICA DE FAVORITOS (Com Rastreamento Avan√ßado) ---
    function toggleFavorite(id, event) {
        event.stopPropagation(); 
        
        let favs = getFavorites();
        const card = document.querySelector(`.evento-card[data-id="${id}"]`);
        
        // Elementos dos contadores (Big button e Mini icon)
        const counterSpan = card ? card.querySelector('.like-count') : null; 
        const miniCounterSpan = card ? card.querySelector('.mini-like-val') : null;

        let currentCount = parseInt(counterSpan ? counterSpan.innerText : 0);
        if (isNaN(currentCount)) currentCount = 0;

        let action = 'add';
        const uuid = getUserId(); 

        if (favs.includes(id)) {
            favs = favs.filter(fid => fid !== id);
            action = 'remove';
            currentCount = Math.max(0, currentCount - 1);
            // GA4: Inten√ß√£o do usu√°rio (j√° existia)
            trackEvent('favoritar_bloco', { 'acao': 'remover', 'bloco_id': id });
        } else {
            favs.push(id);
            action = 'add';
            currentCount++;
            // GA4: Inten√ß√£o do usu√°rio (j√° existia)
            trackEvent('favoritar_bloco', { 'acao': 'adicionar', 'bloco_id': id });
        }
        
        localStorage.setItem('my_blocos', JSON.stringify(favs));
        applyFavoritesUI();
        
        // Atualiza AMBOS os contadores na hora
        if (counterSpan) counterSpan.innerText = currentCount;
        if (miniCounterSpan) miniCounterSpan.innerText = currentCount;

        // NOVO: Monitoramento do Retorno do Servidor (Anti-Spam)
        fetch(`/api/like/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ acao: action, user_id: uuid })
        })
        .then(response => response.json())
        .then(data => {
            // Se o servidor ignorou (por limite de IP ou duplicidade), rastreamos isso
            if (data.status === 'ignored') {
                console.warn("Voto ignorado pelo servidor (Anti-Spam).");
                trackEvent('voto_status', { 
                    'status': 'ignorado', 
                    'motivo': 'limite_ip_ou_duplicidade', 
                    'bloco_id': id 
                });
            } 
            // Se deu sucesso real no banco
            else if (data.status === 'ok') {
                trackEvent('voto_status', { 
                    'status': 'sucesso', 
                    'bloco_id': id 
                });
            }
        })
        .catch(err => {
            console.error("Erro rede like:", err);
            trackEvent('voto_status', { 
                'status': 'erro_rede', 
                'bloco_id': id 
            });
        });
    }

    // ... (fun√ß√£o applyFavoritesUI mantida IGUAL, com a corre√ß√£o do contador visual) ...
    function applyFavoritesUI() {
        const favs = getFavorites();
        const cards = document.querySelectorAll('.evento-card');
        const showOnly = document.getElementById('show-favorites-only') ? document.getElementById('show-favorites-only').checked : false;
        const shareBtn = document.getElementById('share-favs-btn');
        let visibleBlockCount = 0; let blocksSinceLastAd = 0; 
        if (shareBtn) shareBtn.style.display = (showOnly && favs.length > 0) ? 'flex' : 'none';

        cards.forEach(card => {
            const id = card.dataset.id;
            const isFav = favs.includes(id);
            const isEnded = card.classList.contains('status-bg-encerrado');
            const counterSpan = card.querySelector('.like-count');
            const miniCounterSpan = card.querySelector('.mini-like-val');
            
            // L√≥gica para mostrar "1" se acabou de favoritar localmente, mesmo que servidor seja 0
            if (counterSpan) {
                if (!counterSpan.dataset.serverCount) counterSpan.dataset.serverCount = counterSpan.innerText;
                let count = parseInt(counterSpan.dataset.serverCount) || 0;
                
                if (isFav && count === 0) {
                     counterSpan.innerText = "1";
                     if (miniCounterSpan) miniCounterSpan.innerText = "1";
                }
            }

            if (isFav) card.classList.add('is-favorite');
            else card.classList.remove('is-favorite');

            let shouldShow = true;
            if (showOnly && !isFav) shouldShow = false;
            
            const isAd = card.classList.contains('ad-card');
            if (isAd) {
                if (blocksSinceLastAd >= 5) { card.style.display = 'flex'; blocksSinceLastAd = 0; } 
                else { card.style.display = 'none'; }
            } else {
                if (shouldShow) { card.style.display = 'flex'; blocksSinceLastAd++; if (!isEnded) visibleBlockCount++; } 
                else { card.style.display = 'none'; }
            }
        });
        const totalElement = document.querySelector('.total-count');
        if (totalElement) totalElement.textContent = `${visibleBlockCount} blocos encontrados.`;
        
        if (window.markersMap && window.markersFeatureGroup) {
            Object.keys(window.markersMap).forEach(id => {
                const markerObj = window.markersMap[id];
                const isFav = favs.includes(id);
                if (showOnly) {
                    if (isFav) { if (!window.markersFeatureGroup.hasLayer(markerObj.marker)) window.markersFeatureGroup.addLayer(markerObj.marker); } 
                    else { if (window.markersFeatureGroup.hasLayer(markerObj.marker)) window.markersFeatureGroup.removeLayer(markerObj.marker); }
                } else { if (!window.markersFeatureGroup.hasLayer(markerObj.marker)) window.markersFeatureGroup.addLayer(markerObj.marker); }
            });
        }
    }

    // ... (DOMContentLoaded e listeners de mapa mantidos iguais) ...
    document.addEventListener('DOMContentLoaded', function () {
        // ... (c√≥digo existente) ...
        const welcomeModal = document.getElementById('welcome-modal');
        const closeWelcomeBtn = document.getElementById('close-welcome-btn');
        const hasSeenWelcome = localStorage.getItem('seen_welcome_msg_v1');
        if (!hasSeenWelcome && welcomeModal) setTimeout(() => { welcomeModal.classList.add('show'); }, 500);
        if (closeWelcomeBtn && welcomeModal) {
            closeWelcomeBtn.addEventListener('click', () => {
                welcomeModal.classList.remove('show');
                localStorage.setItem('seen_welcome_msg_v1', 'true');
                trackEvent('fechar_tutorial', {'origem': 'modal_boas_vindas'});
            });
        }

        const activeParams = new URLSearchParams(window.location.search);
        const highlightId = activeParams.get('highlight_id');
        cleanUrlParams();
        flatpickr("#data_filtro", { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m", locale: "pt", disableMobile: "true" });

        const favToggle = document.getElementById('show-favorites-only');
        if(favToggle) { 
            favToggle.addEventListener('change', function() {
                applyFavoritesUI();
                trackEvent('filtrar_meus_blocos', { 'acao': this.checked ? 'ativar' : 'desativar' });
            }); 
        }
        applyFavoritesUI();
        
        // GERA UUID NO IN√çCIO PARA GARANTIR RASTREIO
        getUserId();

        // ... (restante do c√≥digo de filtros e mapa igual) ...
        const quickFilters = document.querySelectorAll('input[name="quick_filter"]');
        quickFilters.forEach(qf => { qf.addEventListener('change', function() { if(this.checked) trackEvent('clique_filtro_rapido', {'filtro': this.value}); }); });

        const mapElement = document.getElementById('map');
        if (mapElement) {
            // ... (inicializa√ß√£o do mapa igual) ...
            const formLat = document.getElementById('center_lat').value;
            const formLng = document.getElementById('center_lng').value;
            const formZoom = document.getElementById('zoom').value;
            let initialView = [-19.9167, -43.9345]; let initialZoom = 13; let isSavedState = false;
            if (formLat && formLng && formZoom) { initialView = [parseFloat(formLat), parseFloat(formLng)]; initialZoom = parseInt(formZoom); isSavedState = true; } 
            else if (!highlightId) {
                const savedMapState = localStorage.getItem('mapState');
                if (savedMapState) { try { const parsedState = JSON.parse(savedMapState); if (parsedState.lat && parsedState.lng && parsedState.zoom) { initialView = [parsedState.lat, parsedState.lng]; initialZoom = parsedState.zoom; } } catch(e) {} }
            }

            window.mapInstance = L.map('map', { zoomControl: false }).setView(initialView, initialZoom);
            L.control.zoom({ position: 'topleft' }).addTo(window.mapInstance);
            
            window.mapInstance.on('moveend', function() {
                const center = window.mapInstance.getCenter();
                const zoom = window.mapInstance.getZoom();
                localStorage.setItem('mapState', JSON.stringify({ lat: center.lat, lng: center.lng, zoom: zoom }));
                const searchBtn = document.getElementById('search-in-map-btn');
                if(searchBtn) searchBtn.classList.add('visible');
            });

            // ... (Controles do mapa iguais) ...
            const ResetViewControl = L.Control.extend({
                options: { position: 'topright' },
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom leaflet-control-reset');
                    const button = L.DomUtil.create('a', '', container);
                    button.title = "Visualizar Todos"; button.href = "#";
                    button.onclick = function(e) { e.preventDefault(); if (window.markersFeatureGroup) map.fitBounds(window.markersFeatureGroup.getBounds(), { padding: [20, 20] }); return false; };
                    return container;
                }
            });
            window.mapInstance.addControl(new ResetViewControl());

            const gpsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { className: 'map-tiles' });
            const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], className: 'satellite-tiles' });
            const savedStyle = document.getElementById('map_style').value;
            const satToggle = document.getElementById('satellite-toggle');
            if (savedStyle === 'satellite') { satelliteLayer.addTo(window.mapInstance); if(satToggle) satToggle.checked = true; } else { gpsLayer.addTo(window.mapInstance); if(satToggle) satToggle.checked = false; }
            if (satToggle) { satToggle.addEventListener('change', function() { if (this.checked) { if (window.mapInstance.hasLayer(gpsLayer)) window.mapInstance.removeLayer(gpsLayer); satelliteLayer.addTo(window.mapInstance); document.getElementById('map_style').value = 'satellite'; } else { if (window.mapInstance.hasLayer(satelliteLayer)) window.mapInstance.removeLayer(satelliteLayer); gpsLayer.addTo(window.mapInstance); document.getElementById('map_style').value = 'gps'; } }); }

            const searchBtn = document.getElementById('search-in-map-btn');
            if(searchBtn) {
                searchBtn.addEventListener('click', () => { 
                    trackEvent('mapa_buscar_area', {'origem': 'mapa_btn_flutuante'});
                    const bounds = window.mapInstance.getBounds(); const center = window.mapInstance.getCenter(); const zoom = window.mapInstance.getZoom();
                    document.getElementById('ne_lat').value = bounds.getNorthEast().lat; document.getElementById('ne_lng').value = bounds.getNorthEast().lng;
                    document.getElementById('sw_lat').value = bounds.getSouthWest().lat; document.getElementById('sw_lng').value = bounds.getSouthWest().lng;
                    document.getElementById('center_lat').value = center.lat; document.getElementById('center_lng').value = center.lng; document.getElementById('zoom').value = zoom;
                    document.getElementById('filter-form').submit();
                });
            }

            const locateBtn = document.getElementById('locate-btn');
            let userMarker = null; 
            if (locateBtn) {
                locateBtn.addEventListener('click', function() {
                    trackEvent('mapa_localizacao_click', {'origem': 'mapa_btn'});
                    locateBtn.classList.add('active');
                    if (userMarker) { window.mapInstance.setView(userMarker.getLatLng(), 17); return; }
                    if (navigator.geolocation) {
                        navigator.geolocation.watchPosition(
                            function(position) { const lat = position.coords.latitude; const lng = position.coords.longitude; const newLatLng = [lat, lng]; if (!userMarker) { const userIcon = L.divIcon({ className: 'user-location-marker', html: '<div class="user-dot"></div><div class="user-pulse"></div>', iconSize: [40, 40], iconAnchor: [20, 20] }); userMarker = L.marker(newLatLng, { icon: userIcon }).addTo(window.mapInstance); window.mapInstance.setView(newLatLng, 17, { animate: true }); } else { userMarker.setLatLng(newLatLng); } }, 
                            function(error) { alert("Erro ao obter localiza√ß√£o."); locateBtn.classList.remove('active'); }, { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                        );
                    } else { alert("Geolocaliza√ß√£o n√£o suportada."); }
                });
            }

            window.markersFeatureGroup = L.featureGroup();
            window.markersMap = {};
            const apiParams = new URLSearchParams(activeParams);
            ['ne_lat', 'ne_lng', 'sw_lat', 'sw_lng'].forEach(k => apiParams.delete(k));
            
            fetch("{{ url_for('api_eventos') }}?" + apiParams.toString())
                .then(response => response.json())
                .then(eventos => {
                    eventos.forEach(evento => {
                        if (evento.status === 'encerrado') return; 
                        if (evento.lat && evento.lon) {
                            let radiusSize = 6; if (evento.tamanho === 2) radiusSize = 10; if (evento.tamanho === 3) radiusSize = 16;
                            const markerColor = statusColors[evento.status] || '#E91E63';
                            const defaultStyle = { radius: radiusSize, fillColor: markerColor, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.7 };
                            const marker = L.circleMarker([evento.lat, evento.lon], defaultStyle).addTo(window.markersFeatureGroup);
                            marker.on('click', () => { selectCardFromMap(evento.id); });
                            if (evento.id) window.markersMap[evento.id] = { marker: marker, defaultStyle: defaultStyle };
                        }
                    });
                    window.markersFeatureGroup.addTo(window.mapInstance);
                    if (highlightId) { const card = document.querySelector(`.evento-card[data-id="${highlightId}"]`); if (card) { toggleCard(card); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
                    else if (hasActiveFilters && !isSavedState && window.markersFeatureGroup.getLayers().length > 0) { window.mapInstance.fitBounds(window.markersFeatureGroup.getBounds(), { padding: [30, 30] }); }
                    applyFavoritesUI();
                })
                .catch(err => console.error(err));
        }

        const mobileBtn = document.getElementById('mobile-filter-btn');
        const modal = document.getElementById('mobile-filter-modal');
        const closeBtn = document.getElementById('close-modal-btn');
        const form = document.getElementById('filter-form');
        const mobileContainer = document.getElementById('mobile-filters-container');
        const desktopWrapper = document.querySelector('.filtros-container');
        function adjustFilterLayout() { if (window.innerWidth <= 768) { if (form && mobileContainer && !mobileContainer.contains(form)) mobileContainer.appendChild(form); } else { if (form && desktopWrapper && !desktopWrapper.contains(form)) desktopWrapper.appendChild(form); } }
        window.addEventListener('resize', adjustFilterLayout); adjustFilterLayout();
        if (mobileBtn) { mobileBtn.addEventListener('click', () => modal.classList.add('show')); closeBtn.addEventListener('click', () => modal.classList.remove('show')); window.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); }); }
    });
</script>
{% endblock %}