{% extends "base.html" %}

{% block title %}Blocos de Carnaval MG{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#E91E63">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/carnaval-mask-icon.png') }}">
{% endblock %}

{% block content %}
    
    <div class="main-content-grid">
        <div class="map-container">
            {% include "map.html" %}
        </div>

        <div class="events-list-container">
            
            <div class="filters-wrapper" id="filters-desktop-wrapper">
                <div class="filtros-container">
                    
                    <form id="filter-form" method="GET" action="{{ url_for('mostrar_eventos') }}" autocomplete="off">
                        
                        <div class="quick-filters">
                            <div class="filter-group">
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="hoje" {% if 'hoje' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Hoje</span>
                                </label>
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="amanha" {% if 'amanha' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Amanh√£</span>
                                </label>
                            </div>
                            <div class="filter-group">
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="em-andamento" {% if 'em-andamento' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Em Andamento</span>
                                </label>
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="em-breve" {% if 'em-breve' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Em Breve</span>
                                </label>
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="encerrando" {% if 'encerrando' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Encerrando</span>
                                </label>
                            </div>
                            <div class="filter-group">
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="pequeno" {% if 'pequeno' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Pequenos</span>
                                </label>                    
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="medio" {% if 'medio' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>M√©dios</span>
                                </label>
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="grande" {% if 'grande' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Grandes</span>
                                </label>
                            </div>
                            <div class="filter-group">
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="manha" {% if 'manha' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Manh√£</span>
                                </label>
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="tarde" {% if 'tarde' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Tarde</span>
                                </label>
                                <label class="chip-checkbox">
                                    <input type="checkbox" name="quick_filter" value="noite" {% if 'noite' in request.args.getlist('quick_filter') %}checked{% endif %}>
                                    <span>Noite</span>
                                </label>
                            </div>
                        </div>

                        <input type="hidden" id="ne_lat" name="ne_lat" value="{{ request.args.get('ne_lat', '') }}">
                        <input type="hidden" id="ne_lng" name="ne_lng" value="{{ request.args.get('ne_lng', '') }}">
                        <input type="hidden" id="sw_lat" name="sw_lat" value="{{ request.args.get('sw_lat', '') }}">
                        <input type="hidden" id="sw_lng" name="sw_lng" value="{{ request.args.get('sw_lng', '') }}">
                        <input type="hidden" id="center_lat" name="center_lat" value="{{ request.args.get('center_lat', '') }}">
                        <input type="hidden" id="center_lng" name="center_lng" value="{{ request.args.get('center_lng', '') }}">
                        <input type="hidden" id="zoom" name="zoom" value="{{ request.args.get('zoom', '') }}">
                        <input type="hidden" id="map_style" name="map_style" value="{{ request.args.get('map_style', 'gps') }}">

                        <div class="filters-grid">
                            <div class="filtro-item">
                                <label for="data_filtro">Data:</label>
                                <input type="text" id="data_filtro" name="data_filtro" value="{{ request.args.get('data_filtro', '') }}" placeholder="Selecione..." style="background-color: var(--background-color);">
                            </div>

                            <div class="filtro-item">
                                <label for="bairro">Bairro:</label>
                                <select name="bairro" id="bairro">
                                    <option value="">Todos</option>
                                    {% for b in bairros %}
                                        <option value="{{ b }}" {% if request.args.get('bairro') == b %}selected{% endif %}>{{ b }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="filtro-item">
                                <label for="categoria">Estilo:</label>
                                <select name="categoria" id="categoria">
                                    <option value="">Todos</option>
                                    {% for c in estilos %}
                                        <option value="{{ c }}" {% if request.args.get('categoria') == c %}selected{% endif %}>{{ c }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="filtro-item filtro-busca">
                                <label for="q">Buscar:</label>
                                <input type="text" id="q" name="q" placeholder="Nome..." value="{{ request.args.get('q', '') }}">
                            </div>
                        </div>

                        <div class="filter-actions-row filter-footer">
                            <button type="submit" class="btn-filtrar">Filtrar</button>
                            <button type="button" class="btn-limpar" onclick="resetApp()">Limpar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="results-header">
                <p class="total-count">{{ total }} blocos encontrados.</p>
                <div class="fav-toggle-wrapper">
                    <input type="checkbox" id="show-favorites-only">
                    <label for="show-favorites-only">‚ù§Ô∏è Meus Blocos</label>
                </div>
            </div>

            <div class="eventos-grid" id="events-grid">
                {% for evento in eventos %}
                    <div class="evento-card status-bg-{{ evento.status }}" 
                         data-id="{{ evento.id }}"
                         data-lat="{{ evento.lat }}" 
                         data-lon="{{ evento.lon }}"
                         onclick="toggleCard(this)"> 
                        
                        {% if evento.status_label %}
                            <div class="status-tag status-{{ evento.status }}">
                                {{ evento.status_label }}
                            </div>
                        {% endif %}

                        <div class="evento-info-compact">
                            <div class="card-header">
                                <h2>{{ evento.titulo }}</h2>
                                <div class="header-tags">
                                    {% if evento.is_kids or evento.is_lgbt or evento.is_pet %}
                                    <div class="icons-row">
                                        {% if evento.is_kids %}
                                        <span class="feature-icon feature-kids" title="Infantil"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M19 13H17.91C17.64 10.09 15.33 7.78 12.41 7.54V6C12.41 3.69 13.95 1.78 16.1 1.22C16.7 1.06 17.07 0.43 16.91 -0.17C16.75 -0.77 16.12 -1.14 15.52 -0.98C12.59 0.04 10.37 2.22 10.04 5H9.96C6.66 5.37 4 8.27 4 11.75V15H6V18C6 19.66 7.34 21 9 21C10.66 21 12 19.66 12 18V15H15.5V18C15.5 19.66 16.84 21 18.5 21C20.16 21 21.5 19.66 21.5 18V16.29C23.05 15.38 24 13.62 24 11.75V11C24 10.45 23.55 10 23 10C22.45 10 22 10.45 22 11V11.75C22 12.85 21.1 13.75 20 13.75V13H19ZM9 18C8.45 18 8 17.55 8 17V15H10V17C10 17.55 9.55 18 9 18ZM18.5 18C17.95 18 17.5 17.55 17.5 17V16H19.5V17C19.5 17.55 19.05 18 18.5 18Z" transform="translate(0, 2)"/> </svg></span>
                                        {% endif %}
                                        {% if evento.is_lgbt %}
                                        <span class="feature-icon feature-lgbt" title="LGBTQIA+"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" stroke="none"><rect x="2" y="4" width="28" height="4" fill="#FF4B4B"/><rect x="2" y="8" width="28" height="4" fill="#FFB04B"/><rect x="2" y="12" width="28" height="4" fill="#FFEB3B"/><rect x="2" y="16" width="28" height="4" fill="#4CAF50"/><rect x="2" y="20" width="28" height="4" fill="#2196F3"/><rect x="2" y="24" width="28" height="4" fill="#9C27B0"/></svg></span>
                                        {% endif %}
                                        {% if evento.is_pet %}
                                        <span class="feature-icon feature-pet" title="Pet Friendly"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2C10.5 2 9 3.5 9 5C9 6.5 10.5 8 12 8C13.5 8 15 6.5 15 5C15 3.5 13.5 2 12 2ZM5 5C3.5 5 2 6.5 2 8C2 9.5 3.5 11 5 11C6.5 11 8 9.5 8 8C8 6.5 6.5 5 5 5ZM19 5C17.5 5 16 6.5 16 8C16 9.5 17.5 11 19 11C20.5 11 22 9.5 22 8C22 6.5 20.5 5 19 5ZM4 13.5C4 16.5 6 22 12 22C18 22 20 16.5 20 13.5C20 12 18 10 16 10C14.5 10 14 11 12 11C10 11 9.5 10 8 10C6 10 4 12 4 13.5Z"/></svg></span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <span class="tamanho-tag tamanho-{{ evento.tamanho }}">
                                        {% if evento.tamanho == 3 %}Grande üë•üë•üë•{% elif evento.tamanho == 2 %}M√©dio üë•{% else %}Pequeno üë§{% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card-meta">
                                <div class="meta-row date-row">
                                    <div class="date-wrapper">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                        <strong>{{ evento.data }}</strong>
                                    </div>
                                    <span class="categoria-tag">{{ evento.categoria_display }}</span>
                                </div>
                                <div class="meta-row address-row">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                    <span>{{ evento.endereco }}</span>
                                </div>
                            </div>

                            {% if evento.descricao|length > 1 %}
                            <div class="card-desc">
                                <p>{{ evento.descricao }}</p>
                            </div>
                            {% endif %}

                            <div class="expand-content">
                                <div class="card-actions">
                                    {% if evento.lat and evento.lon %}
                                    <button class="directions-btn" onclick="getDirections({{ evento.lat }}, {{ evento.lon }}, event)">
                                        üöó Como Chegar
                                    </button>
                                    {% endif %}
                                    
                                    <button class="share-btn" title="Compartilhar no WhatsApp" onclick="shareBlock('{{ evento.id }}', '{{ evento.titulo }}', '{{ evento.data }}', event)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01A9.816 9.816 0 0 0 12.04 2zM12.05 20.21c-1.5 0-2.96-.39-4.27-1.15l-.3-.18-3.11.82.83-3.04-.19-.31a8.173 8.173 0 0 1-1.26-4.44c0-4.52 3.69-8.21 8.21-8.21 2.19 0 4.25.86 5.8 2.4 1.55 1.55 2.41 3.61 2.41 5.8 0 4.53-3.69 8.21-8.21 8.21z"/></svg>
                                    </button>

                                    <button class="fav-btn" title="Salvar em Meus Blocos" onclick="toggleFavorite('{{ evento.id }}', event)">
                                        <svg class="heart-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p style="grid-column: 1/-1; text-align: center; margin-top: 2em; color: var(--text-secondary);">
                        Nenhum bloco encontrado nesta √°rea/filtro.
                    </p>
                {% endfor %}
            </div>
        </div>

        <button id="mobile-filter-btn" class="mobile-filter-btn" title="Abrir Filtros">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </button>

        <div id="mobile-filter-modal" class="mobile-filter-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Filtros</h2>
                    <button id="close-modal-btn" class="close-modal-btn">√ó</button>
                </div>
                <div id="mobile-filters-container"></div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<script>
    const hasActiveFilters = {{ 'true' if has_filters else 'false' }};

    const ICONS = {
        kids: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M19 13H17.91C17.64 10.09 15.33 7.78 12.41 7.54V6C12.41 3.69 13.95 1.78 16.1 1.22C16.7 1.06 17.07 0.43 16.91 -0.17C16.75 -0.77 16.12 -1.14 15.52 -0.98C12.59 0.04 10.37 2.22 10.04 5H9.96C6.66 5.37 4 8.27 4 11.75V15H6V18C6 19.66 7.34 21 9 21C10.66 21 12 19.66 12 18V15H15.5V18C15.5 19.66 16.84 21 18.5 21C20.16 21 21.5 19.66 21.5 18V16.29C23.05 15.38 24 13.62 24 11.75V11C24 10.45 23.55 10 23 10C22.45 10 22 10.45 22 11V11.75C22 12.85 21.1 13.75 20 13.75V13H19ZM9 18C8.45 18 8 17.55 8 17V15H10V17C10 17.55 9.55 18 9 18ZM18.5 18C17.95 18 17.5 17.55 17.5 17V16H19.5V17C19.5 17.55 19.05 18 18.5 18Z" transform="translate(0, 2)"/> </svg>`,
        lgbt: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 32 32" stroke="none"><rect x="2" y="4" width="28" height="4" fill="#FF4B4B"/><rect x="2" y="8" width="28" height="4" fill="#FFB04B"/><rect x="2" y="12" width="28" height="4" fill="#FFEB3B"/><rect x="2" y="16" width="28" height="4" fill="#4CAF50"/><rect x="2" y="20" width="28" height="4" fill="#2196F3"/><rect x="2" y="24" width="28" height="4" fill="#9C27B0"/></svg>`,
        pet: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2C10.5 2 9 3.5 9 5C9 6.5 10.5 8 12 8C13.5 8 15 6.5 15 5C15 3.5 13.5 2 12 2ZM5 5C3.5 5 2 6.5 2 8C2 9.5 3.5 11 5 11C6.5 11 8 9.5 8 8C8 6.5 6.5 5 5 5ZM19 5C17.5 5 16 6.5 16 8C16 9.5 17.5 11 19 11C20.5 11 22 9.5 22 8C22 6.5 20.5 5 19 5ZM4 13.5C4 16.5 6 22 12 22C18 22 20 16.5 20 13.5C20 12 18 10 16 10C14.5 10 14 11 12 11C10 11 9.5 10 8 10C6 10 4 12 4 13.5Z"/></svg>`
    };

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); });
    }

    const statusColors = {
        'em-andamento': '#27ae60', 'em-breve': '#2196F3', 'encerrando': '#d35400',
        'hoje': '#8e44ad', 'encerrado': '#95a5a6', 'futuro': '#E91E63'
    };

    function cleanUrlParams() {
        const url = new URL(window.location);
        const paramsToRemove = [
            'ne_lat', 'ne_lng', 'sw_lat', 'sw_lng', 'center_lat', 'center_lng', 'zoom',
            'quick_filter', 'status_filter', 'data_filtro', 'periodo_dia', 'bairro', 'categoria', 'q'
        ];
        let changed = false;
        
        paramsToRemove.forEach(param => {
            if (url.searchParams.has(param)) {
                url.searchParams.delete(param);
                changed = true;
            }
        });
        
        if (url.searchParams.has('highlight_id')) {
            url.searchParams.delete('highlight_id');
            changed = true;
        }

        if (changed) {
            window.history.replaceState({}, '', url);
        }
    }

    function resetApp() {
        localStorage.removeItem('mapState');
        window.location.href = '/';
    }

    // UPDATED: User-provided structure (No Emojis)
    function shareBlock(id, title, date, event) {
        event.stopPropagation();
        
        const baseUrl = window.location.origin + window.location.pathname;
        const link = `${baseUrl}?highlight_id=${id}`;
        
        const message = `Bora nesse bloco? \n\n*${title}*\n ${date}\n\n Veja aqui: ${link}`;
        
        const waUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(waUrl, '_blank');
    }

    function getDirections(destLat, destLon, event) {
        if(event) event.stopPropagation();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    window.open(`http://googleusercontent.com/maps.google.com/maps?saddr=${userLat},${userLng}&daddr=${destLat},${destLon}`, '_blank');
                },
                (error) => {
                    window.open(`http://googleusercontent.com/maps.google.com/maps?daddr=${destLat},${destLon}`, '_blank');
                }
            );
        } else {
            window.open(`http://googleusercontent.com/maps.google.com/maps?daddr=${destLat},${destLon}`, '_blank');
        }
    }

    // UPDATED: Check for expanded class to stop unwanted map moves
    function toggleCard(card) {
        // Fecha outros cards abertos
        document.querySelectorAll('.evento-card.expanded').forEach(c => {
            if (c !== card) c.classList.remove('expanded');
        });
        
        // Alterna o estado do card atual
        card.classList.toggle('expanded');
        
        // Se o card foi fechado, n√£o faz nada no mapa
        if (!card.classList.contains('expanded')) {
            return;
        }

        const id = card.dataset.id;
        const lat = parseFloat(card.dataset.lat);
        const lon = parseFloat(card.dataset.lon);

        if (window.mapInstance && !isNaN(lat) && !isNaN(lon)) {
            
            // --- IN√çCIO DO C√ÅLCULO DE CENTRALIZA√á√ÉO ---
            const targetZoom = 16; // Zoom ao clicar
            
            // AJUSTE AQUI A POSI√á√ÉO VERTICAL DO MARCADOR:
            // -50 (Negativo) = O marcador fica ABAIXO do centro da tela.
            //  150 (Positivo) = O marcador fica ACIMA do centro (bom se tiver bot√£o embaixo).
            //  0  = Exatamente no centro.
            const offsetPixels = -50; 

            // 1. Projeta a coordenada (lat/lon) para pixels
            const targetPoint = window.mapInstance.project([lat, lon], targetZoom);
            
            // 2. Desloca o centro do mapa
            // Se 'offsetPixels' √© negativo (-50), subtra√≠mos do Y. O centro do mapa sobe, o marcador desce visualmente.
            const newTargetPoint = targetPoint.add([0, offsetPixels]);
            
            // 3. Converte de volta para Lat/Lon
            const newLatLon = window.mapInstance.unproject(newTargetPoint, targetZoom);

            // 4. Move o mapa suavemente
            window.mapInstance.flyTo(newLatLon, targetZoom, { duration: 1.2 });
            // --- FIM DO C√ÅLCULO ---
            
            // L√≥gica visual do marcador (pulo e popup)
            if (window.markersMap[id]) {
                const current = window.markersMap[id];
                const markerElement = current.marker.getElement(); 
                
                // Efeito de pulso no marcador
                if (markerElement) {
                    markerElement.classList.remove('marker-active-pulse');
                    void markerElement.offsetWidth; // For√ßa reflow
                    markerElement.classList.add('marker-active-pulse');
                    setTimeout(() => { markerElement.classList.remove('marker-active-pulse'); }, 1000);
                }
                
                // Traz para frente e abre o bal√£o
                current.marker.bringToFront();
                setTimeout(() => {
                    current.marker.openPopup();
                }, 300);
            }
        }
    }

    function getFavorites() {
        return JSON.parse(localStorage.getItem('my_blocos') || '[]');
    }

    function toggleFavorite(id, event) {
        event.stopPropagation(); 
        let favs = getFavorites();
        if (favs.includes(id)) {
            favs = favs.filter(fid => fid !== id);
        } else {
            favs.push(id);
        }
        localStorage.setItem('my_blocos', JSON.stringify(favs));
        applyFavoritesUI();
    }

    function applyFavoritesUI() {
        const favs = getFavorites();
        const cards = document.querySelectorAll('.evento-card');
        const showOnly = document.getElementById('show-favorites-only').checked;
        
        let visibleCount = 0;

        cards.forEach(card => {
            const id = card.dataset.id;
            const isFav = favs.includes(id);
            
            if (isFav) card.classList.add('is-favorite');
            else card.classList.remove('is-favorite');

            if (showOnly) {
                if (!isFav) {
                    card.style.display = 'none';
                } else {
                    card.style.display = 'flex';
                    visibleCount++;
                }
            } else {
                card.style.display = 'flex';
                visibleCount++;
            }
        });

        const totalElement = document.querySelector('.total-count');
        if (totalElement) {
            totalElement.textContent = `${visibleCount} blocos encontrados.`;
        }

        if (window.markersMap && window.markersFeatureGroup) {
            Object.keys(window.markersMap).forEach(id => {
                const markerObj = window.markersMap[id];
                const isFav = favs.includes(id);
                if (showOnly) {
                    if (isFav) {
                        if (!window.markersFeatureGroup.hasLayer(markerObj.marker)) {
                            window.markersFeatureGroup.addLayer(markerObj.marker);
                        }
                    } else {
                        if (window.markersFeatureGroup.hasLayer(markerObj.marker)) {
                            window.markersFeatureGroup.removeLayer(markerObj.marker);
                        }
                    }
                } else {
                    if (!window.markersFeatureGroup.hasLayer(markerObj.marker)) {
                        window.markersFeatureGroup.addLayer(markerObj.marker);
                    }
                }
            });
        }
    }

document.addEventListener('DOMContentLoaded', function () {
    
    const activeParams = new URLSearchParams(window.location.search);
    const highlightId = activeParams.get('highlight_id');

    cleanUrlParams();

    flatpickr("#data_filtro", { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m", locale: "pt", disableMobile: "true" });

    const favToggle = document.getElementById('show-favorites-only');
    if(favToggle) { favToggle.addEventListener('change', applyFavoritesUI); }
    applyFavoritesUI();

    const mapElement = document.getElementById('map');
    if (mapElement) {
        const formLat = document.getElementById('center_lat').value;
        const formLng = document.getElementById('center_lng').value;
        const formZoom = document.getElementById('zoom').value;

        let initialView = [-19.9167, -43.9345];
        let initialZoom = 13;
        let isSavedState = false;

        if (formLat && formLng && formZoom) {
            initialView = [parseFloat(formLat), parseFloat(formLng)];
            initialZoom = parseInt(formZoom);
            isSavedState = true;
        } 
        else if (!highlightId) {
            const savedMapState = localStorage.getItem('mapState');
            if (savedMapState) {
                try {
                    const parsedState = JSON.parse(savedMapState);
                    if (parsedState.lat && parsedState.lng && parsedState.zoom) {
                        initialView = [parsedState.lat, parsedState.lng];
                        initialZoom = parsedState.zoom;
                    }
                } catch(e) { console.error("Map state error", e); }
            }
        }

        window.mapInstance = L.map('map', { zoomControl: false }).setView(initialView, initialZoom);
        L.control.zoom({ position: 'topleft' }).addTo(window.mapInstance);

        window.mapInstance.on('moveend', function() {
            const center = window.mapInstance.getCenter();
            const zoom = window.mapInstance.getZoom();
            const state = { lat: center.lat, lng: center.lng, zoom: zoom };
            localStorage.setItem('mapState', JSON.stringify(state));
            
            const searchBtn = document.getElementById('search-in-map-btn');
            if(searchBtn) searchBtn.classList.add('visible');
        });

        const ResetViewControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom leaflet-control-reset');
                const button = L.DomUtil.create('a', '', container);
                button.title = "Visualizar Todos";
                button.href = "#";
                button.onclick = function(e) {
                    e.preventDefault();
                    if (window.markersFeatureGroup) {
                        map.fitBounds(window.markersFeatureGroup.getBounds(), { padding: [20, 20] });
                    }
                    return false;
                };
                return container;
            }
        });
        window.mapInstance.addControl(new ResetViewControl());

        const gpsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { className: 'map-tiles' });
        const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], className: 'satellite-tiles' });

        const savedStyle = document.getElementById('map_style').value;
        const satToggle = document.getElementById('satellite-toggle');
        
        const satContainer = document.getElementById('satellite-toggle-container');
        if (satContainer) {
            L.DomEvent.disableClickPropagation(satContainer);
            L.DomEvent.disableScrollPropagation(satContainer);
        }

        if (savedStyle === 'satellite') { satelliteLayer.addTo(window.mapInstance); if(satToggle) satToggle.checked = true; } 
        else { gpsLayer.addTo(window.mapInstance); if(satToggle) satToggle.checked = false; }

        if (satToggle) {
            satToggle.addEventListener('change', function() {
                if (this.checked) {
                    if (window.mapInstance.hasLayer(gpsLayer)) window.mapInstance.removeLayer(gpsLayer);
                    satelliteLayer.addTo(window.mapInstance);
                    document.getElementById('map_style').value = 'satellite';
                } else {
                    if (window.mapInstance.hasLayer(satelliteLayer)) window.mapInstance.removeLayer(satelliteLayer);
                    gpsLayer.addTo(window.mapInstance);
                    document.getElementById('map_style').value = 'gps';
                }
            });
        }

        const searchBtn = document.getElementById('search-in-map-btn');
        if(searchBtn) {
            searchBtn.addEventListener('click', () => { 
                const bounds = window.mapInstance.getBounds();
                const center = window.mapInstance.getCenter();
                const zoom = window.mapInstance.getZoom();
                document.getElementById('ne_lat').value = bounds.getNorthEast().lat;
                document.getElementById('ne_lng').value = bounds.getNorthEast().lng;
                document.getElementById('sw_lat').value = bounds.getSouthWest().lat;
                document.getElementById('sw_lng').value = bounds.getSouthWest().lng;
                document.getElementById('center_lat').value = center.lat;
                document.getElementById('center_lng').value = center.lng;
                document.getElementById('zoom').value = zoom;
                document.getElementById('filter-form').submit();
            });
        }

        const locateBtn = document.getElementById('locate-btn');
        let userMarker = null; let watchId = null; let isFollowing = false;
        if (locateBtn) {
            locateBtn.addEventListener('click', function() {
                if (watchId !== null) {
                    isFollowing = true;
                    locateBtn.classList.add('active'); 
                    if (userMarker) window.mapInstance.setView(userMarker.getLatLng(), 17);
                    return;
                }
                if (navigator.geolocation) {
                    locateBtn.classList.add('active'); 
                    isFollowing = true;
                    watchId = navigator.geolocation.watchPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const newLatLng = [lat, lng];
                        if (!userMarker) {
                            const userIcon = L.divIcon({ className: 'user-location-marker', html: '<div class="user-dot"></div><div class="user-pulse"></div>', iconSize: [40, 40], iconAnchor: [20, 20] });
                            userMarker = L.marker(newLatLng, { icon: userIcon }).addTo(window.mapInstance);
                            userMarker.bindPopup("<b>Voc√™ est√° aqui</b>");
                        } else { userMarker.setLatLng(newLatLng); }
                        if (isFollowing) window.mapInstance.setView(newLatLng, 17, { animate: true });
                    }, function(error) { alert("Erro GPS."); locateBtn.classList.remove('active'); }, { enableHighAccuracy: true });
                    window.mapInstance.on('dragstart', function() { isFollowing = false; locateBtn.classList.remove('active'); });
                }
            });
        }

        window.markersFeatureGroup = L.featureGroup();
        window.markersMap = {};
        
        const apiParams = new URLSearchParams(activeParams);
        ['ne_lat', 'ne_lng', 'sw_lat', 'sw_lng'].forEach(k => apiParams.delete(k));
        
        fetch("{{ url_for('api_eventos') }}?" + apiParams.toString())
            .then(response => response.json())
            .then(eventos => {
                eventos.forEach(evento => {
                    if (evento.status === 'encerrado') return; 
                    if (evento.lat && evento.lon) {
                        let radiusSize = 6; 
                        if (evento.tamanho === 2) radiusSize = 10;
                        if (evento.tamanho === 3) radiusSize = 16;

                        let tamanhoLabel = 'Pequeno üë§';
                        if (evento.tamanho === 2) tamanhoLabel = 'M√©dio üë•';
                        if (evento.tamanho === 3) tamanhoLabel = 'Grande üë•üë•üë•';

                        const markerColor = statusColors[evento.status] || '#E91E63';
                        const defaultStyle = { radius: radiusSize, fillColor: markerColor, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.7 };
                        const marker = L.circleMarker([evento.lat, evento.lon], defaultStyle).addTo(window.markersFeatureGroup);
                        if (evento.id) window.markersMap[evento.id] = { marker: marker, style: defaultStyle };
                        
                        let iconsHtml = '<div style="display:flex; gap:4px; flex-shrink: 0;">'; 
                        if (evento.is_kids) iconsHtml += `<span class="feature-icon feature-kids">${ICONS.kids}</span>`;
                        if (evento.is_lgbt) iconsHtml += `<span class="feature-icon feature-lgbt">${ICONS.lgbt}</span>`;
                        if (evento.is_pet) iconsHtml += `<span class="feature-icon feature-pet">${ICONS.pet}</span>`;
                        iconsHtml += '</div>';

                        const popupContent = `
                            <div style="font-family: 'Poppins', sans-serif;">
                                <strong style="color: ${markerColor};">${evento.titulo}</strong><br>
                                <span style="font-size:0.8em; background:#eee; padding:1px 4px; border-radius:3px; margin-right:5px;">${tamanhoLabel}</span>
                                <span style="font-size:0.8em; color:#666; background:#f0f0f0; padding:1px 4px; border-radius:3px;">${evento.categoria_display}</span><br>
                                <span style="font-size:0.85em; color:#666;">${evento.data}</span><br>
                                <div style="margin-top:4px; font-size:0.8em;">${evento.endereco}</div>
                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-top: 8px;">
                                    <button onclick="getDirections(${evento.lat}, ${evento.lon}, event)" class="directions-btn" style="margin-top: 0; flex: 1;">
                                        üöó Como Chegar
                                    </button>
                                    ${iconsHtml}
                                </div>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    }
                });
                window.markersFeatureGroup.addTo(window.mapInstance);
                
                if (highlightId) {
                    const card = document.querySelector(`.evento-card[data-id="${highlightId}"]`);
                    if (card) {
                        toggleCard(card);
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                else if (hasActiveFilters && !isSavedState && window.markersFeatureGroup.getLayers().length > 0) {
                    window.mapInstance.fitBounds(window.markersFeatureGroup.getBounds(), { padding: [30, 30] });
                }
                
                applyFavoritesUI();
            })
            .catch(err => console.error(err));
    }

    const mobileBtn = document.getElementById('mobile-filter-btn');
    const modal = document.getElementById('mobile-filter-modal');
    const closeBtn = document.getElementById('close-modal-btn');
    const form = document.getElementById('filter-form');
    const mobileContainer = document.getElementById('mobile-filters-container');
    const desktopWrapper = document.querySelector('.filtros-container');

    function adjustFilterLayout() {
        if (window.innerWidth <= 768) {
            if (form && mobileContainer && !mobileContainer.contains(form)) mobileContainer.appendChild(form);
        } else {
            if (form && desktopWrapper && !desktopWrapper.contains(form)) desktopWrapper.appendChild(form);
        }
    }
    window.addEventListener('resize', adjustFilterLayout);
    adjustFilterLayout();

    if (mobileBtn) {
        mobileBtn.addEventListener('click', () => modal.classList.add('show'));
        closeBtn.addEventListener('click', () => modal.classList.remove('show'));
        window.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
    }
});
</script>
{% endblock %}