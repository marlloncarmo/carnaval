{% extends "base.html" %}

{% block title %}Blocos de Carnaval MG{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
{% endblock %}

{% block content %}
    
    <div class="main-content-grid">
        <div class="map-container">
            {% include "map.html" %}
        </div>

        <div class="events-list-container">
            
            <div class="filters-wrapper" id="filters-desktop-wrapper">
                <div class="filtros-container">
                    <form id="filter-form" method="GET" action="{{ url_for('mostrar_eventos') }}">
                        <input type="hidden" id="ne_lat" name="ne_lat" value="{{ request.args.get('ne_lat', '') }}">
                        <input type="hidden" id="ne_lng" name="ne_lng" value="{{ request.args.get('ne_lng', '') }}">
                        <input type="hidden" id="sw_lat" name="sw_lat" value="{{ request.args.get('sw_lat', '') }}">
                        <input type="hidden" id="sw_lng" name="sw_lng" value="{{ request.args.get('sw_lng', '') }}">
                        
                        <input type="hidden" id="center_lat" name="center_lat" value="{{ request.args.get('center_lat', '') }}">
                        <input type="hidden" id="center_lng" name="center_lng" value="{{ request.args.get('center_lng', '') }}">
                        <input type="hidden" id="zoom" name="zoom" value="{{ request.args.get('zoom', '') }}">
                        <input type="hidden" id="map_style" name="map_style" value="{{ request.args.get('map_style', 'gps') }}">

                        <div class="filtro-item">
                            <label for="data_filtro">Data (Dia/MÃªs):</label>
                            <input type="text" id="data_filtro" name="data_filtro" value="{{ request.args.get('data_filtro', '') }}" placeholder="Selecione..." style="background-color: var(--background-color);">
                        </div>
                        
                        <div class="filtro-item">
                            <label for="periodo_dia">PerÃ­odo:</label>
                            <select name="periodo_dia" id="periodo_dia">
                                <option value="">Todos</option>
                                <option value="manha" {% if request.args.get('periodo_dia') == 'manha' %}selected{% endif %}>ManhÃ£ (05h-12h)</option>
                                <option value="tarde" {% if request.args.get('periodo_dia') == 'tarde' %}selected{% endif %}>Tarde (12h-18h)</option>
                                <option value="noite" {% if request.args.get('periodo_dia') == 'noite' %}selected{% endif %}>Noite (18h+)</option>
                            </select>
                        </div>

                        <div class="filtro-item">
                            <label for="bairro">Bairro:</label>
                            <select name="bairro" id="bairro">
                                <option value="">Todos</option>
                                {% for b in bairros %}
                                    <option value="{{ b }}" {% if request.args.get('bairro') == b %}selected{% endif %}>{{ b }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filtro-item">
                            <label for="categoria">Estilo:</label>
                            <select name="categoria" id="categoria">
                                <option value="">Todos</option>
                                {% for c in estilos %}
                                    <option value="{{ c }}" {% if request.args.get('categoria') == c %}selected{% endif %}>{{ c }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filtro-item filtro-busca">
                            <label for="q">Buscar:</label>
                            <input type="text" id="q" name="q" placeholder="Nome..." value="{{ request.args.get('q', '') }}">
                        </div>

                        <div class="filter-actions-row">
                            <button type="submit" class="btn-filtrar">Filtrar</button>
                            <a href="{{ url_for('mostrar_eventos') }}" class="btn-limpar" onclick="clearMapBounds()">Limpar</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <p class="total-count">{{ total }} blocos encontrados.</p>

            <div class="eventos-grid">
                {% for evento in eventos %}
                    <div class="evento-card status-bg-{{ evento.status }}" 
                         data-id="{{ evento.id }}"
                         data-lat="{{ evento.lat }}" 
                         data-lon="{{ evento.lon }}">
                        
                        {% if evento.status_label %}
                            <div class="status-tag status-{{ evento.status }}">
                                {{ evento.status_label }}
                            </div>
                        {% endif %}

                        <div class="evento-info-compact">
                            <div class="card-header">
                                <h2>{{ evento.titulo }}</h2>
                                <div class="header-tags">
                                    {% if evento.is_kids or evento.is_lgbt or evento.is_pet %}
                                    <div class="icons-row">
                                        {% if evento.is_kids %}
                                        <span class="feature-icon feature-kids" title="Infantil - Baby Friendly">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M19 13H17.91C17.64 10.09 15.33 7.78 12.41 7.54V6C12.41 3.69 13.95 1.78 16.1 1.22C16.7 1.06 17.07 0.43 16.91 -0.17C16.75 -0.77 16.12 -1.14 15.52 -0.98C12.59 0.04 10.37 2.22 10.04 5H9.96C6.66 5.37 4 8.27 4 11.75V15H6V18C6 19.66 7.34 21 9 21C10.66 21 12 19.66 12 18V15H15.5V18C15.5 19.66 16.84 21 18.5 21C20.16 21 21.5 19.66 21.5 18V16.29C23.05 15.38 24 13.62 24 11.75V11C24 10.45 23.55 10 23 10C22.45 10 22 10.45 22 11V11.75C22 12.85 21.1 13.75 20 13.75V13H19ZM9 18C8.45 18 8 17.55 8 17V15H10V17C10 17.55 9.55 18 9 18ZM18.5 18C17.95 18 17.5 17.55 17.5 17V16H19.5V17C19.5 17.55 19.05 18 18.5 18Z" transform="translate(0, 2)"/> </svg>
                                        </span>
                                        {% endif %}
                                        {% if evento.is_lgbt %}
                                        <span class="feature-icon feature-lgbt" title="LGBTQIA+">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" stroke="none"><rect x="2" y="4" width="28" height="4" fill="#FF4B4B"/><rect x="2" y="8" width="28" height="4" fill="#FFB04B"/><rect x="2" y="12" width="28" height="4" fill="#FFEB3B"/><rect x="2" y="16" width="28" height="4" fill="#4CAF50"/><rect x="2" y="20" width="28" height="4" fill="#2196F3"/><rect x="2" y="24" width="28" height="4" fill="#9C27B0"/></svg>
                                        </span>
                                        {% endif %}
                                        {% if evento.is_pet %}
                                        <span class="feature-icon feature-pet" title="Pet Friendly">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2C10.5 2 9 3.5 9 5C9 6.5 10.5 8 12 8C13.5 8 15 6.5 15 5C15 3.5 13.5 2 12 2ZM5 5C3.5 5 2 6.5 2 8C2 9.5 3.5 11 5 11C6.5 11 8 9.5 8 8C8 6.5 6.5 5 5 5ZM19 5C17.5 5 16 6.5 16 8C16 9.5 17.5 11 19 11C20.5 11 22 9.5 22 8C22 6.5 20.5 5 19 5ZM4 13.5C4 16.5 6 22 12 22C18 22 20 16.5 20 13.5C20 12 18 10 16 10C14.5 10 14 11 12 11C10 11 9.5 10 8 10C6 10 4 12 4 13.5Z"/></svg>
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <span class="tamanho-tag tamanho-{{ evento.tamanho }}">
                                        {% if evento.tamanho == 3 %}Grande ðŸ‘¥ðŸ‘¥ðŸ‘¥{% elif evento.tamanho == 2 %}MÃ©dio ðŸ‘¥{% else %}Pequeno ðŸ‘¤{% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card-meta">
                                <div class="meta-row date-row">
                                    <div class="date-wrapper">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                        <strong>{{ evento.data }}</strong>
                                    </div>
                                    <span class="categoria-tag">{{ evento.categoria }}</span>
                                </div>
                                <div class="meta-row address-row">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                    <span>{{ evento.endereco }}</span>
                                </div>
                            </div>

                            {% if evento.descricao|length > 1 %}
                            <div class="card-desc">
                                <p>{{ evento.descricao }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <p style="grid-column: 1/-1; text-align: center; margin-top: 2em; color: var(--text-secondary);">
                        Nenhum bloco encontrado nesta Ã¡rea/filtro.
                    </p>
                {% endfor %}
            </div>
        </div>

        <button id="mobile-filter-btn" class="mobile-filter-btn" title="Abrir Filtros">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </button>

        <div id="mobile-filter-modal" class="mobile-filter-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Filtros</h2>
                    <button id="close-modal-btn" class="close-modal-btn">&times;</button>
                </div>
                <div id="mobile-filters-container"></div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<script>
    const statusColors = {
        'em-andamento': '#27ae60', // Green
        'em-breve': '#2196F3',     // Blue
        'encerrando': '#d35400',   // Orange
        'hoje': '#8e44ad',         // Purple
        'encerrado': '#95a5a6',    // Gray
        'futuro': '#E91E63'        // Default Pink
    };

    function clearMapBounds() {
        ['ne_lat', 'ne_lng', 'sw_lat', 'sw_lng', 'center_lat', 'center_lng', 'zoom'].forEach(id => {
            document.getElementById(id).value = '';
        });
    }

document.addEventListener('DOMContentLoaded', function () {
    
    flatpickr("#data_filtro", {
        dateFormat: "Y-m-d", 
        altInput: true,      
        altFormat: "d/m",    
        locale: "pt",        
        disableMobile: "true" 
    });

    const mapElement = document.getElementById('map');
    if (mapElement) {
        const urlParams = new URLSearchParams(window.location.search);
        const savedLat = urlParams.get('center_lat');
        const savedLng = urlParams.get('center_lng');
        const savedZoom = urlParams.get('zoom');

        let initialView = [-19.9167, -43.9345];
        let initialZoom = 13;
        let isSavedState = false;

        if (savedLat && savedLng && savedZoom) {
            initialView = [parseFloat(savedLat), parseFloat(savedLng)];
            initialZoom = parseInt(savedZoom);
            isSavedState = true;
        }

        window.mapInstance = L.map('map', { zoomControl: false }).setView(initialView, initialZoom);
        L.control.zoom({ position: 'topleft' }).addTo(window.mapInstance);

        const ResetViewControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom leaflet-control-reset');
                const button = L.DomUtil.create('a', '', container);
                button.title = "Visualizar Todos";
                button.href = "#";
                button.onclick = function(e) {
                    e.preventDefault();
                    if (window.markersFeatureGroup) {
                        map.fitBounds(window.markersFeatureGroup.getBounds(), { padding: [20, 20] });
                    }
                    return false;
                };
                return container;
            }
        });
        window.mapInstance.addControl(new ResetViewControl());

        const gpsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            className: 'map-tiles'
        });

        const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3'],
            className: 'satellite-tiles'
        });

        const savedStyle = document.getElementById('map_style').value;
        const satToggle = document.getElementById('satellite-toggle');
        
        if (savedStyle === 'satellite') {
            satelliteLayer.addTo(window.mapInstance);
            if(satToggle) satToggle.checked = true;
        } else {
            gpsLayer.addTo(window.mapInstance);
            if(satToggle) satToggle.checked = false;
        }

        const satContainer = document.getElementById('satellite-toggle-container');
        if(satContainer) L.DomEvent.disableClickPropagation(satContainer);
        
        if (satToggle) {
            satToggle.addEventListener('change', function() {
                if (this.checked) {
                    if (window.mapInstance.hasLayer(gpsLayer)) window.mapInstance.removeLayer(gpsLayer);
                    satelliteLayer.addTo(window.mapInstance);
                    document.getElementById('map_style').value = 'satellite';
                } else {
                    if (window.mapInstance.hasLayer(satelliteLayer)) window.mapInstance.removeLayer(satelliteLayer);
                    gpsLayer.addTo(window.mapInstance);
                    document.getElementById('map_style').value = 'gps';
                }
            });
        }

        const searchBtn = document.getElementById('search-in-map-btn');
        window.mapInstance.on('moveend', () => { if(searchBtn) searchBtn.classList.add('visible'); });
        
        if(searchBtn) {
            searchBtn.addEventListener('click', () => { 
                const bounds = window.mapInstance.getBounds();
                const center = window.mapInstance.getCenter();
                const zoom = window.mapInstance.getZoom();
                
                document.getElementById('ne_lat').value = bounds.getNorthEast().lat;
                document.getElementById('ne_lng').value = bounds.getNorthEast().lng;
                document.getElementById('sw_lat').value = bounds.getSouthWest().lat;
                document.getElementById('sw_lng').value = bounds.getSouthWest().lng;
                
                document.getElementById('center_lat').value = center.lat;
                document.getElementById('center_lng').value = center.lng;
                document.getElementById('zoom').value = zoom;
                
                document.getElementById('filter-form').submit();
            });
        }

        const locateBtn = document.getElementById('locate-btn');
        let userMarker = null;
        let watchId = null;
        let isFollowing = false;

        if (locateBtn) {
            locateBtn.addEventListener('click', function() {
                if (watchId !== null) {
                    isFollowing = true;
                    locateBtn.classList.add('active'); 
                    if (userMarker) {
                        window.mapInstance.setView(userMarker.getLatLng(), 17);
                    }
                    return;
                }

                if (navigator.geolocation) {
                    locateBtn.classList.add('active'); 
                    isFollowing = true;

                    watchId = navigator.geolocation.watchPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const newLatLng = [lat, lng];

                        if (!userMarker) {
                            const userIcon = L.divIcon({
                                className: 'user-location-marker',
                                html: '<div class="user-dot"></div><div class="user-pulse"></div>',
                                iconSize: [40, 40], 
                                iconAnchor: [20, 20] 
                            });
                            userMarker = L.marker(newLatLng, { icon: userIcon }).addTo(window.mapInstance);
                            userMarker.bindPopup("<b>VocÃª estÃ¡ aqui</b>");
                        } else {
                            userMarker.setLatLng(newLatLng);
                        }

                        if (isFollowing) {
                            window.mapInstance.setView(newLatLng, 17, { animate: true });
                        }

                    }, function(error) {
                        alert("NÃ£o foi possÃ­vel obter sua localizaÃ§Ã£o.");
                        console.error("Geolocation error:", error);
                        locateBtn.classList.remove('active');
                    }, {
                        enableHighAccuracy: true,
                        maximumAge: 10000,
                        timeout: 10000
                    });

                    window.mapInstance.on('dragstart', function() {
                        isFollowing = false;
                        locateBtn.classList.remove('active'); 
                    });

                } else {
                    alert("Seu navegador nÃ£o suporta geolocalizaÃ§Ã£o.");
                }
            });
        }

        window.markersFeatureGroup = L.featureGroup();
        window.markersMap = {};
        window.selectedMarker = null;

        const currentParams = new URLSearchParams(window.location.search);
        currentParams.delete('ne_lat');
        currentParams.delete('ne_lng');
        currentParams.delete('sw_lat');
        currentParams.delete('sw_lng');
        
        fetch("{{ url_for('api_eventos') }}?" + currentParams.toString())
            .then(response => response.json())
            .then(eventos => {
                eventos.forEach(evento => {
                    // --- CHANGED: SKIP 'ENCERRADO' MARKERS ---
                    if (evento.status === 'encerrado') return; 

                    if (evento.lat && evento.lon) {
                        let radiusSize = 6; 
                        let tamanhoLabel = "Pequeno";
                        if (evento.tamanho === 2) { radiusSize = 10; tamanhoLabel = "MÃ©dio"; }
                        if (evento.tamanho === 3) { radiusSize = 16; tamanhoLabel = "Grande"; }

                        // Color Logic
                        const markerColor = statusColors[evento.status] || '#E91E63';

                        const defaultStyle = {
                            radius: radiusSize,
                            fillColor: markerColor,
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.7
                        };

                        const marker = L.circleMarker([evento.lat, evento.lon], defaultStyle)
                            .addTo(window.markersFeatureGroup);
                        
                        if (evento.id) {
                            window.markersMap[evento.id] = { marker: marker, style: defaultStyle };
                        }

                        const popupContent = `
                            <div style="font-family: 'Poppins', sans-serif;">
                                <strong style="color: ${markerColor};">${evento.titulo}</strong><br>
                                <span style="font-size:0.8em; background:#eee; padding:1px 4px; border-radius:3px; margin-right:5px;">${tamanhoLabel}</span>
                                <span style="font-size:0.85em; color:#666;">${evento.data}</span><br>
                                <div style="margin-top:4px; font-size:0.8em;">${evento.endereco}</div>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    }
                });

                window.markersFeatureGroup.addTo(window.mapInstance);
                
                if (!isSavedState && window.markersFeatureGroup.getLayers().length > 0) {
                    window.mapInstance.fitBounds(window.markersFeatureGroup.getBounds(), {
                        padding: [30, 30]
                    });
                }
            })
            .catch(err => console.error("Erro mapa:", err));
    }

    const cards = document.querySelectorAll('.evento-card');
    cards.forEach(card => {
        card.addEventListener('click', () => {
            cards.forEach(c => c.classList.remove('highlighted'));
            card.classList.add('highlighted');

            const lat = card.dataset.lat;
            const lon = card.dataset.lon;
            const id = card.dataset.id;

            if (window.mapInstance) {
                if (lat && lon) {
                    window.mapInstance.setView([lat, lon], 16, { animate: true, duration: 1.0 });
                }

                if (window.selectedMarker && window.markersMap[window.selectedMarker]) {
                    const prev = window.markersMap[window.selectedMarker];
                    prev.marker.setStyle(prev.style);
                }

                if (id && window.markersMap[id]) {
                    const current = window.markersMap[id];
                    
                    // --- TRIGGER PULSE ANIMATION ON CLICK ---
                    const markerElement = current.marker.getElement();
                    if (markerElement) {
                        markerElement.classList.remove('marker-active-pulse');
                        void markerElement.offsetWidth; // Reflow
                        markerElement.classList.add('marker-active-pulse');
                        
                        setTimeout(() => {
                            markerElement.classList.remove('marker-active-pulse');
                        }, 1000);
                    }
                    
                    current.marker.bringToFront();
                }
            }
        });
    });

    const mobileBtn = document.getElementById('mobile-filter-btn');
    const modal = document.getElementById('mobile-filter-modal');
    const closeBtn = document.getElementById('close-modal-btn');
    const form = document.getElementById('filter-form');
    const mobileContainer = document.getElementById('mobile-filters-container');
    const desktopWrapper = document.querySelector('.filtros-container');

    function adjustFilterLayout() {
        if (window.innerWidth <= 768) {
            if (form && mobileContainer && !mobileContainer.contains(form)) {
                mobileContainer.appendChild(form);
            }
        } else {
            if (form && desktopWrapper && !desktopWrapper.contains(form)) {
                desktopWrapper.appendChild(form);
            }
        }
    }
    window.addEventListener('resize', adjustFilterLayout);
    adjustFilterLayout();

    if (mobileBtn) {
        mobileBtn.addEventListener('click', () => modal.classList.add('show'));
        closeBtn.addEventListener('click', () => modal.classList.remove('show'));
        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('show');
        });
    }
});
</script>
{% endblock %}